2025-03-12 17:55:57 - INFO - Starting enhanced cell type deconvolution pipeline
2025-03-12 17:55:57 - INFO - Bulk data: /private/groups/russelllab/jodie/wolbachia_induced_DE/scanpy_clustering/scanpy_objects/bulk_adata.h5ad
2025-03-12 17:55:57 - INFO - Reference data: /private/groups/russelllab/jodie/wolbachia_induced_DE/scanpy_clustering/data/atlas/fca_subset.h5ad
2025-03-12 17:55:57 - INFO - Output directory: /private/groups/russelllab/jodie/wolbachia_induced_DE/wolbachia_induced_differentiation/scripts/celltype_clustering/claude/deconvolution/claude_v2/fca_subset
2025-03-12 17:55:57 - INFO - Normalization method: all
2025-03-12 17:55:57 - INFO - Loading data files...
2025-03-12 17:55:57 - INFO - Bulk dataset loaded: (24, 10957) (samples × genes)
2025-03-12 17:57:25 - INFO - Reference dataset loaded: (5000, 2431) (cells × genes)
2025-03-12 17:57:25 - INFO - Number of shared genes: 1234
2025-03-12 17:57:25 - INFO - Using 1234 shared genes
/private/groups/russelllab/jodie/wolbachia_induced_DE/wolbachia_induced_differentiation/scripts/celltype_clustering/claude/deconvolution/claude_v2/cell_type_deconvolution.py:329: RuntimeWarning: invalid value encountered in log10
  m, b = np.polyfit(np.log10(bulk_means), np.log10(ref_means), 1)
/private/groups/russelllab/jodie/wolbachia_induced_DE/wolbachia_induced_differentiation/scripts/celltype_clustering/claude/deconvolution/claude_v2/cell_type_deconvolution.py:335: RuntimeWarning: invalid value encountered in log10
  corr = np.corrcoef(np.log10(bulk_means), np.log10(ref_means))[0, 1]
2025-03-12 17:58:06 - INFO - Distribution comparison plots for before normalization saved
/private/home/jomojaco/mambaforge/envs/scanpy/lib/python3.12/site-packages/anndata/_core/merge.py:1357: UserWarning: Only some AnnData objects have `.raw` attribute, not concatenating `.raw` attributes.
  warn(
2025-03-12 17:58:14 - INFO - PCA comparison for before normalization saved
2025-03-12 17:58:14 - INFO - Trying all normalization methods and selecting the best
2025-03-12 17:58:14 - INFO - Scaling bulk expression to match scRNA-seq levels (gene-specific scaling)...
2025-03-12 17:59:13 - INFO - Bulk expression scaling completed
/private/groups/russelllab/jodie/wolbachia_induced_DE/wolbachia_induced_differentiation/scripts/celltype_clustering/claude/deconvolution/claude_v2/cell_type_deconvolution.py:329: RuntimeWarning: invalid value encountered in log10
  m, b = np.polyfit(np.log10(bulk_means), np.log10(ref_means), 1)
2025-03-12 17:59:17 - WARNING - Could not calculate correlation line: SVD did not converge in Linear Least Squares
2025-03-12 17:59:18 - INFO - Distribution comparison plots for scale normalization saved
/private/home/jomojaco/mambaforge/envs/scanpy/lib/python3.12/site-packages/anndata/_core/merge.py:1357: UserWarning: Only some AnnData objects have `.raw` attribute, not concatenating `.raw` attributes.
  warn(
2025-03-12 17:59:25 - INFO - PCA comparison for scale normalization saved
2025-03-12 17:59:25 - INFO - Performing quantile normalization between datasets...
2025-03-12 18:00:00 - INFO - Quantile normalization completed
/private/groups/russelllab/jodie/wolbachia_induced_DE/wolbachia_induced_differentiation/scripts/celltype_clustering/claude/deconvolution/claude_v2/cell_type_deconvolution.py:329: RuntimeWarning: invalid value encountered in log10
  m, b = np.polyfit(np.log10(bulk_means), np.log10(ref_means), 1)
2025-03-12 18:00:06 - WARNING - Could not calculate correlation line: SVD did not converge in Linear Least Squares
2025-03-12 18:00:07 - INFO - Distribution comparison plots for quantile normalization saved
/private/home/jomojaco/mambaforge/envs/scanpy/lib/python3.12/site-packages/anndata/_core/merge.py:1357: UserWarning: Only some AnnData objects have `.raw` attribute, not concatenating `.raw` attributes.
  warn(
2025-03-12 18:00:07 - INFO - PCA comparison for quantile normalization saved
2025-03-12 18:00:07 - INFO - Applying simplified harmonization between datasets...
/private/home/jomojaco/mambaforge/envs/scanpy/lib/python3.12/site-packages/scanpy/preprocessing/_normalization.py:233: UserWarning: Some cells have zero counts
  warn(UserWarning("Some cells have zero counts"))
/private/home/jomojaco/mambaforge/envs/scanpy/lib/python3.12/site-packages/scanpy/preprocessing/_simple.py:377: RuntimeWarning: invalid value encountered in log1p
  np.log1p(X, out=X)
WARNING: adata.X seems to be already log-transformed.
2025-03-12 18:00:42 - ERROR - Deconvolution pipeline failed: Bin edges must be unique: Index([nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan,
       nan, nan, nan, nan, nan, nan, nan],
      dtype='float64').
You can drop duplicate edges by setting the 'duplicates' kwarg
2025-03-12 18:00:42 - ERROR - Traceback (most recent call last):
  File "/private/groups/russelllab/jodie/wolbachia_induced_DE/wolbachia_induced_differentiation/scripts/celltype_clustering/claude/deconvolution/claude_v2/main_deconvolution.py", line 154, in main
    harmonized_bulk, harmonized_ref = harmonize_datasets(bulk_subset, ref_subset, shared_genes)
                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/private/groups/russelllab/jodie/wolbachia_induced_DE/wolbachia_induced_differentiation/scripts/celltype_clustering/claude/deconvolution/claude_v2/cell_type_deconvolution.py", line 195, in harmonize_datasets
    sc.pp.highly_variable_genes(ref_subset, n_top_genes=2000, flavor="seurat")
  File "/private/home/jomojaco/mambaforge/envs/scanpy/lib/python3.12/site-packages/legacy_api_wrap/__init__.py", line 80, in fn_compatible
    return fn(*args_all, **kw)
           ^^^^^^^^^^^^^^^^^^^
  File "/private/home/jomojaco/mambaforge/envs/scanpy/lib/python3.12/site-packages/scanpy/preprocessing/_highly_variable_genes.py", line 648, in highly_variable_genes
    df = _highly_variable_genes_single_batch(
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/private/home/jomojaco/mambaforge/envs/scanpy/lib/python3.12/site-packages/scanpy/preprocessing/_highly_variable_genes.py", line 281, in _highly_variable_genes_single_batch
    df["mean_bin"] = _get_mean_bins(df["means"], flavor, n_bins)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/private/home/jomojaco/mambaforge/envs/scanpy/lib/python3.12/site-packages/scanpy/preprocessing/_highly_variable_genes.py", line 307, in _get_mean_bins
    return pd.cut(means, bins=bins)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/private/home/jomojaco/mambaforge/envs/scanpy/lib/python3.12/site-packages/pandas/core/reshape/tile.py", line 257, in cut
    fac, bins = _bins_to_cuts(
                ^^^^^^^^^^^^^^
  File "/private/home/jomojaco/mambaforge/envs/scanpy/lib/python3.12/site-packages/pandas/core/reshape/tile.py", line 443, in _bins_to_cuts
    raise ValueError(
ValueError: Bin edges must be unique: Index([nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan,
       nan, nan, nan, nan, nan, nan, nan],
      dtype='float64').
You can drop duplicate edges by setting the 'duplicates' kwarg

